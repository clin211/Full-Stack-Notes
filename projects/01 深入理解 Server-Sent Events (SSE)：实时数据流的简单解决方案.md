## ç®€ä»‹
åœ¨ Web å¼€å‘ä¸­ï¼Œå®æ—¶æ•°æ®ä¼ è¾“çš„é‡è¦æ€§æ—¥ç›Šå¢å¼ºã€‚æ— è®ºæ˜¯è‚¡ç¥¨å¸‚åœºçš„å³æ—¶æ›´æ–°ã€åœ¨çº¿èŠå¤©åº”ç”¨çš„å®æ—¶æ¶ˆæ¯ï¼Œè¿˜æ˜¯ç‰©è”ç½‘è®¾å¤‡çš„æ•°æ®æµï¼Œå®æ—¶é€šä¿¡éƒ½å‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚ä¼ ç»Ÿçš„ HTTP è¯·æ±‚-å“åº”æ¨¡å‹åœ¨å¤„ç†å®æ—¶æ•°æ®æ—¶æ˜¾å¾—ä¸è¶³ï¼Œè€Œ WebSocket å’Œ Server-Sent Eventsï¼ˆSSEï¼‰åˆ™æ˜¯ä¸¤ç§å¸¸è§çš„è§£å†³æ–¹æ¡ˆã€‚

### SSE æ˜¯ä»€ä¹ˆï¼Ÿ
SSE å…¨ç§°ä¸º Server-sent events , æ˜¯ä¸€ç§åŸºäº HTTP åè®®çš„é€šä¿¡æŠ€æœ¯ï¼Œå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€æ›´æ–°ã€‚

å®ƒæ˜¯ HTML5 æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œè®¾è®¡åˆè¡·æ˜¯ç”¨æ¥å»ºç«‹ä¸€ä¸ªå•å‘çš„æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯è¿æ¥ï¼Œä½¿å¾—æœåŠ¡å™¨å¯ä»¥å®æ—¶åœ°å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚

è¿™ç§æœåŠ¡ç«¯å®æ—¶å‘å®¢æˆ·ç«¯å‘é€æ•°æ®çš„ä¼ è¾“æ–¹å¼ï¼Œå…¶å®å°±æ˜¯æµå¼ä¼ è¾“ã€‚

### SSE ä¸ WebSockets å’Œ HTTP è½®è¯¢çš„åŒºåˆ«
| **ç‰¹æ€§** | **SSE** | **WebSockets** | **HTTP è½®è¯¢** |
| -------------- | ---------------------------------------------------- | ------------------------------------------------- | ------------------------------------------------------------ |
| **é€šä¿¡æ¨¡å¼** | å•å‘é€šä¿¡ï¼ŒæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ® | å…¨åŒå·¥é€šä¿¡ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åŒæ—¶å‘é€æ•°æ® | å®¢æˆ·ç«¯å®šæœŸå‘é€è¯·æ±‚æ£€æŸ¥æœåŠ¡å™¨æ•°æ® |
| **è¿æ¥ç®¡ç†** | åŸºäº HTTP çš„æŒä¹…å•å‘è¿æ¥ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿å’Œäº‹ä»¶ ID ç®¡ç† | ç‹¬ç«‹çš„ WebSocket åè®®ï¼Œéœ€ç®¡ç†è¿æ¥çš„æ‰“å¼€å’Œå…³é—­ | æ¯æ¬¡è½®è¯¢éƒ½æ˜¯ç‹¬ç«‹çš„ HTTP è¯·æ±‚ï¼Œå¼€é”€å¤§ |
| **åè®®å’Œæ ‡å‡†** | åŸºäº HTTPï¼Œä½¿ç”¨ `text/event-stream` å†…å®¹ç±»å‹æ¨é€äº‹ä»¶ | ç‹¬ç«‹çš„ WebSocket åè®®ï¼ˆws:// æˆ– wss://ï¼‰ | ä½¿ç”¨æ ‡å‡† HTTP åè®®ï¼Œé€šè¿‡åå¤å‘é€è¯·æ±‚è½®è¯¢ |
| **æµè§ˆå™¨æ”¯æŒ** | å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œè‡ªåŠ¨å¤„ç†é‡è¿ | å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨åŸç”Ÿæ”¯æŒï¼Œéœ€ WebSocket æœåŠ¡å™¨æ”¯æŒ | ä»»ä½•æ”¯æŒ HTTP çš„æµè§ˆå™¨éƒ½æ”¯æŒ |
| **åº”ç”¨åœºæ™¯** | é€‚åˆå•å‘æ•°æ®æ¨é€åœºæ™¯ï¼Œå¦‚æ–°é—»æ¨é€ã€å®æ—¶é€šçŸ¥ | é€‚åˆåŒå‘å®æ—¶é€šä¿¡åœºæ™¯ï¼Œå¦‚å®æ—¶èŠå¤©ã€åœ¨çº¿æ¸¸æˆ | é€‚åˆå®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œæˆ–ä¸æ”¯æŒ SSE/WebSockets æ—¶çš„æ›¿ä»£æ–¹æ¡ˆ |
| **æ€§èƒ½å’Œæ•ˆç‡** | æŒä¹…è¿æ¥ï¼Œé€‚ç”¨äºä¸­ç­‰æ•°æ®é‡å’Œé¢‘ç‡è¾ƒä½åœºæ™¯ï¼Œæ¯”è½®è¯¢é«˜æ•ˆ | åŒå‘é€šä¿¡ï¼Œé«˜é¢‘äº¤äº’ä¸‹æ•ˆç‡æ›´é«˜ï¼Œä½†ç®¡ç†æ›´å¤æ‚ | æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯å®Œæ•´çš„ HTTP è¯·æ±‚ï¼Œæ•ˆç‡æœ€ä½ï¼Œå¼€é”€æœ€å¤§ |


### é€‚ç”¨åœºæ™¯
1. **å®æ—¶é€šçŸ¥å’Œæ›´æ–°**ï¼šSSE éå¸¸é€‚åˆéœ€è¦æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ•°æ®çš„åœºæ™¯ï¼Œå¦‚æ–°é—»æ¨é€ã€ä½“è‚²æ¯”åˆ†ã€è‚¡ç¥¨ä»·æ ¼æ›´æ–°ç­‰ã€‚

2. **å®æ—¶ç¤¾äº¤åª’ä½“é€šçŸ¥**ï¼šä¾‹å¦‚åœ¨ç¤¾äº¤å¹³å°ä¸Šï¼Œç”¨æˆ·æ”¶åˆ°çš„æ–°æ¶ˆæ¯æé†’ã€ç‚¹èµæˆ–è¯„è®ºé€šçŸ¥ï¼Œä½¿ç”¨ SSE å¯ä»¥åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ï¼Œä¿æŒæ•°æ®åŒæ­¥ã€‚

3. **æ—¥å¿—æˆ–è¿›åº¦ç›‘æ§**ï¼šSSE å¸¸ç”¨äºå‘å®¢æˆ·ç«¯æ¨é€æœåŠ¡å™¨ä¸Šçš„å®æ—¶æ—¥å¿—æˆ–è¿›ç¨‹è¿›åº¦æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯åœ¨é•¿æ—¶é—´ä»»åŠ¡çš„çŠ¶æ€æ›´æ–°ä¸­ï¼ˆå¦‚æ–‡ä»¶ä¸Šä¼ ã€æ•°æ®å¤„ç†ä»»åŠ¡ï¼‰ã€‚

4. **å®æ—¶ä»ªè¡¨ç›˜**ï¼šåœ¨éœ€è¦å±•ç¤ºå®æ—¶æ•°æ®çš„ä»ªè¡¨ç›˜åœºæ™¯ä¸‹ï¼ŒSSE å¯ä»¥æ¨é€æœåŠ¡å™¨çŠ¶æ€ã€ä¼ æ„Ÿå™¨æ•°æ®ã€ç³»ç»Ÿå¥åº·çŠ¶å†µç­‰åŠ¨æ€ä¿¡æ¯ã€‚

5. **èŠå¤©å’Œæ¶ˆæ¯æ¨é€**ï¼šè™½ç„¶ SSE æ˜¯å•å‘çš„ï¼Œä½†åœ¨ä¸€å¯¹å¤šçš„åœºæ™¯ä¸‹ï¼ŒæœåŠ¡å™¨å¯ä»¥å°†æ¶ˆæ¯æ¨é€ç»™å¤šä¸ªå®¢æˆ·ç«¯ç”¨æˆ·ï¼Œå¦‚å•å‘çš„å…¬å‘Šæ¶ˆæ¯ã€å®æ—¶æé†’ç­‰ã€‚

6. **ç‰©è”ç½‘è®¾å¤‡æ•°æ®æ›´æ–°**ï¼šç”¨äºç‰©è”ç½‘åœºæ™¯ä¸­ï¼ŒSSE å¯ä»¥æ¨é€æ¥è‡ªè®¾å¤‡çš„æ•°æ®æ›´æ–°ï¼Œä¾‹å¦‚ä¼ æ„Ÿå™¨æ•°æ®æˆ–ç¯å¢ƒç›‘æ§ä¿¡æ¯ã€‚

7. **ç›´æ’­è¯„è®º**ï¼šåœ¨è§†é¢‘æµæˆ–ç›´æ’­å¹³å°ä¸Šï¼ŒSSE å¯ä»¥ç”¨äºæ¨é€ç”¨æˆ·è¯„è®ºæˆ–å¼¹å¹•ï¼Œä½¿è§‚ä¼—èƒ½å®æ—¶çœ‹åˆ°äº’åŠ¨ä¿¡æ¯ã€‚

## SSE åŸºæœ¬åŸç†

SSE æ˜¯ä¸€ç§åŸºäº HTTP åè®®çš„æœåŠ¡å™¨æ¨é€æŠ€æœ¯ï¼Œå®ƒé€šè¿‡ HTTP è¿æ¥å®ç°æœåŠ¡å™¨å‘å®¢æˆ·ç«¯çš„å®æ—¶æ•°æ®æ¨é€ã€‚SSE çš„åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š

å®¢æˆ·ç«¯é€šè¿‡ HTTP è¿æ¥å‘æœåŠ¡å™¨å‘é€ SSE è¯·æ±‚ã€‚
æœåŠ¡å™¨æ¥æ”¶åˆ° SSE è¯·æ±‚åï¼Œä¿æŒ HTTP è¿æ¥ä¸æ–­å¼€ï¼Œå¹¶å®šæœŸå‘å®¢æˆ·ç«¯å‘é€ SSEæ•°æ®ã€‚
å®¢æˆ·ç«¯æ¥æ”¶åˆ° SSE æ•°æ®åï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå¤„ç†ã€‚

åœ¨ SSE æŠ€æœ¯ä¸­ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„è¿æ¥æ˜¯é•¿è¿æ¥ï¼Œè€Œä¸æ˜¯çŸ­è¿æ¥ã€‚è¿™æ„å‘³ç€HTTP è¿æ¥åœ¨å‘é€ SSE æ•°æ®åä¸ä¼šç«‹å³å…³é—­ï¼Œè€Œæ˜¯ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œç›´åˆ°æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ã€‚
SSE æŠ€æœ¯ä½¿ç”¨çš„æ˜¯æ ‡å‡†çš„ HTTP åè®®ï¼Œå¹¶ä¸éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„åè®®æˆ–æ’ä»¶ï¼Œå› æ­¤å¯ä»¥åœ¨ç°æœ‰çš„ Web æµè§ˆå™¨ä¸­å®ç°ã€‚

### SSE çš„æ•°æ®æ ¼å¼
æœåŠ¡å™¨å‘æµè§ˆå™¨å‘é€çš„ SSE æ•°æ®ï¼Œå¿…é¡»æ˜¯ UTF-8 ç¼–ç çš„æ–‡æœ¬ï¼Œå…·æœ‰å¦‚ä¸‹çš„ HTTP å¤´ä¿¡æ¯:
```txt
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
```
`Content-Type` å¿…é¡»æŒ‡å®š MIME ç±»å‹ä¸º `event-steam`
æ¯ä¸€æ¬¡å‘é€çš„ä¿¡æ¯ï¼Œç”±è‹¥å¹²ä¸ª message ç»„æˆï¼Œæ¯ä¸ª messageä¹‹é—´ç”¨ `\n\n` åˆ†éš”ã€‚æ¯ä¸ª message å†…éƒ¨ç”±è‹¥å¹²è¡Œç»„æˆï¼Œæ¯ä¸€è¡Œéƒ½æ˜¯å¦‚ä¸‹æ ¼å¼ã€‚
```
[field]: value\n
```
ä¸Šé¢çš„ field å¯ä»¥å–å››ä¸ªå€¼ï¼š`data`ã€`event`ã€`id`ã€`retry`

#### data å­—æ®µ
æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯æ¨é€çš„æ•°æ®å°±æ”¾åœ¨ data ä¸­ï¼Œå¦‚æœæ•°æ®å¾ˆé•¿ï¼Œå¯ä»¥åˆ†æˆå¤šè¡Œï¼Œæ¯è¡Œå‰é¢éƒ½ç”¨ `\n` ç»“å°¾ï¼Œæœ€åä¸€è¡Œç”¨ `\n\n` ç»“å°¾ã€‚æ¯”å¦‚ï¼š
```json
{"message":"Hello World","timestamp":"2024-09-12T22:48:23.599Z"}
```
SSE çš„ä¼ è¾“æ ¼å¼ï¼š
```txt
data: {\n
data: "message":"Hello World",\n
data: "timestamp":"2024-09-12T22:48:23.599Z"\n
data: }\n\n
```

#### id å­—æ®µ
ç”¨äºè¡¨ç¤ºæ•°æ®çš„ï¼Œç›¸å½“äºæ¯ä¸€æ¡æ•°æ®çš„ç¼–å·ã€‚
```txt
id: 100031870159
event: custom
date: Thu Sep 12 2024 17:04:30 GMT+0800 (China Standard Time)
data: {"message":"Hello World","timestamp":"2024-09-12T22:54:30.159Z"}
```

#### event å­—æ®µ
event å­—æ®µè¡¨ç¤ºè‡ªå®šä¹‰çš„äº‹ä»¶ç±»å‹ï¼Œé»˜è®¤æ˜¯ `message` äº‹ä»¶ã€‚æµè§ˆå™¨å¯ä»¥ç”¨ `addEventListener` ä¸­ç›‘å¬è¯¥äº‹ä»¶ã€‚
```txt
id: 1000131368488
event: custom
date: Thu Sep 12 2024 16:56:08 GMT+0800 (China Standard Time)
data: {"message":"Hello World","timestamp":"2024-09-12T22:56:08.488Z"}
```
`event: custom` å°±æ˜¯è‡ªå®šä¹‰ä¸ªäº‹ä»¶ç±»å‹ï¼Œåœ¨å®¢æˆ·ç«¯ç›‘å¬çš„æ—¶å€™ï¼Œå°±ç›´æ¥ç›‘å¬ `custom` ç±»å‹ã€‚

#### retry ç±»å‹
æœåŠ¡å™¨å¯ä»¥ç”¨ `retry` å­—æ®µï¼Œè‡ªå®šä¹‰å®¢æˆ·ç«¯é‡æ–°å‘èµ·è¿æ¥çš„æ—¶é—´é—´éš”ã€‚
```txt
retry: 10000\n  // 10s
```
ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´æµè§ˆå™¨é‡æ–°å‘èµ·è¿æ¥ï¼š
- æ—¶é—´é—´éš”åˆ°æœŸã€‚
- ç”±äºç½‘ç»œé”™è¯¯ç­‰åŸå› ï¼Œå¯¼è‡´è¿æ¥å‡ºé”™ã€‚


#### `:` å­—æ®µ
é™¤äº†ä¸Šé¢å››ä¸ªå­—æ®µå¤–ï¼Œè¿˜æœ‰å†’å·å¼€å¤´çš„è¡Œï¼Œè¡¨ç¤ºæ³¨é‡Šã€‚æ¯”å¦‚ä¸‹é¢ï¼š
```
: This is a comment
```
ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­:
```txt
: this is a comment
id: 1000132214389
event: custom
date: Thu Sep 12 2024 17:10:14 GMT+0800 (China Standard Time)
data: {"message":"Hello World","timestamp":"2024-09-12T22:46:14.389Z"}
```
## SSE çš„ä¼˜åŠ¿ä¸å±€é™
**ä¼˜åŠ¿**ï¼š
- SSE ä½¿ç”¨ HTTP åè®®ï¼Œç°æœ‰çš„æœåŠ¡å™¨è½¯ä»¶éƒ½æ”¯æŒã€‚ æ˜¯ä¸€ä¸ªç‹¬ç«‹åè®®ã€‚

- SSE å±äºè½»é‡çº§ï¼Œä½¿ç”¨ç®€å•ï¼›WS åè®®ç›¸å¯¹å¤æ‚ã€‚
- SSE é»˜è®¤æ”¯æŒæ–­çº¿é‡è¿ï¼ŒWebSocket éœ€è¦è‡ªå·±å®ç°ã€‚
- SSE ä¸€èˆ¬åªç”¨æ¥ä¼ é€æ–‡æœ¬ï¼ŒäºŒè¿›åˆ¶æ•°æ®éœ€è¦ç¼–ç åä¼ é€ï¼ŒWS é»˜è®¤æ”¯æŒä¼ é€äºŒè¿›åˆ¶æ•°æ®ã€‚
- SSE æ”¯æŒè‡ªå®šä¹‰å‘é€çš„æ¶ˆæ¯ç±»å‹ã€‚

**å±€é™**ï¼š
- æœåŠ¡ç«¯å•å‘æ¨é€æ¶ˆæ¯ï¼Œä¸æ˜¯å…¨åŒå·¥å¯ä»¥åŒå‘é€šä¿¡ã€‚

- åè®®ä¸æ”¯æŒäºŒè¿›åˆ¶ä¼ è¾“ï¼Œéœ€è¦ä½¿ç”¨æ–¹æŠŠç°åœ¨è½¬æˆäºŒè¿›åˆ¶æ ¼å¼ã€‚


### SSE çš„æ ¸å¿ƒä»·å€¼

SSEï¼ˆServer-Sent Eventsï¼‰çš„æ ¸å¿ƒä»·å€¼ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **å®æ—¶æ€§**: SSE å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè€Œæ— éœ€å®¢æˆ·ç«¯ä¸æ–­å‘èµ·è½®è¯¢è¯·æ±‚ã€‚å¯¹äºéœ€è¦é¢‘ç¹æ›´æ–°çš„åœºæ™¯ï¼Œå¦‚é€šçŸ¥ã€æ•°æ®æµæ›´æ–°ç­‰ï¼ŒSSE å¯ä»¥ç¡®ä¿å®¢æˆ·ç«¯å®æ—¶è·å–æœ€æ–°æ•°æ®ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

2. **è½»é‡çº§å’Œç®€å•å®ç°**: ç›¸æ¯” WebSocketsï¼ŒSSE æ›´åŠ è½»é‡ï¼ŒåŸºäºç°æœ‰çš„ HTTP åè®®ï¼Œæ˜“äºå®ç°ï¼Œä¸éœ€è¦å¤æ‚çš„æ¡æ‰‹æœºåˆ¶å’Œåè®®å¤„ç†ã€‚åªéœ€æœåŠ¡å™¨ç«¯æ¨é€æ–‡æœ¬æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¾¿èƒ½è½»æ¾æ¥æ”¶å¹¶å¤„ç†ã€‚

3. **èŠ‚çœèµ„æº**: ä¼ ç»Ÿçš„ HTTP è½®è¯¢ä¼šé¢‘ç¹å‘èµ·è¯·æ±‚ï¼Œå ç”¨å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æºï¼Œè€Œ SSE ä½¿ç”¨å•ä¸€çš„é•¿è¿æ¥è¿›è¡Œæ•°æ®æ¨é€ï¼Œæ˜¾è‘—é™ä½äº†æœåŠ¡å™¨è´Ÿè½½å’Œç½‘ç»œèµ„æºæ¶ˆè€—ã€‚

4. **è‡ªåŠ¨é‡è¿æœºåˆ¶**: SSE å†…ç½®äº†è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥æ–­å¼€æ—¶ä¼šè‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥ï¼Œæ— éœ€é¢å¤–å®ç°å¤æ‚çš„æ¢å¤é€»è¾‘ã€‚

5. **æµè§ˆå™¨æ”¯æŒå¥½**: SSE æ˜¯åŸºäº HTTP/1.1 æ ‡å‡†çš„æŠ€æœ¯ï¼Œå¹¿æ³›æ”¯æŒå„å¤§æµè§ˆå™¨ï¼Œå®¢æˆ·ç«¯å¯ä»¥è½»æ¾é€šè¿‡åŸç”Ÿçš„ `EventSource` API æ¥å®ç°ï¼Œä¸ç°æœ‰çš„ Web æŠ€æœ¯æ ˆå…¼å®¹æ€§é«˜ã€‚

6. **å•å‘æ¨é€é€‚ç”¨æ€§å¼º**: å¯¹äºå•å‘æ¶ˆæ¯æ¨é€çš„åœºæ™¯ï¼Œå¦‚æ–°é—»æ›´æ–°ã€ç³»ç»Ÿé€šçŸ¥ã€å®æ—¶æ•°æ®ç›‘æ§ç­‰ï¼ŒSSE éå¸¸é€‚åˆï¼Œå› ä¸ºå®ƒä¸“æ³¨äºä»æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œè€Œæ— éœ€å¤æ‚çš„åŒå‘é€šä¿¡ã€‚

## SSE çš„å‰ç«¯å®ç°
EventSource æ¥å£æ˜¯ web å†…å®¹ä¸æœåŠ¡å™¨å‘é€äº‹ä»¶é€šä¿¡çš„æ¥å£ã€‚

ä¸€ä¸ª EventSource å®ä¾‹ä¼šå¯¹ HTTP æœåŠ¡å™¨å¼€å¯ä¸€ä¸ªæŒä¹…åŒ–çš„è¿æ¥ï¼Œä»¥ `text/event-stream` æ ¼å¼å‘é€äº‹ä»¶ï¼Œæ­¤è¿æ¥ä¼šä¸€ç›´ä¿æŒå¼€å¯ç›´åˆ°é€šè¿‡è°ƒç”¨ `EventSource.close()` å…³é—­ã€‚


### å…¼å®¹æ€§
ä» [can i use](https://caniuse.com/?search=server%20sent%20event) ä¸­å¯ä»¥çœ‹å‡º SSE çš„å…¼å®¹æ€§è¿˜æ˜¯å¾ˆä¸é”™çš„ï¼Œé™¤äº† IE å’Œ Opera Mini å¤–ï¼Œå…¶ä»–éƒ½æ²¡é—®é¢˜

![æˆªå›¾è‡ª can i use](./assets/a6807628-3440-4ff0-b3f2-5f9db6f0a8b7.png)

åœ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿå¯ä»¥é€šè¿‡ in æ“ä½œç¬¦å»æ£€æµ‹å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒ SSEï¼š
```js
if ('EventSource' in window) {
    // ...
}
```

### åˆ›å»º SSE å®ä¾‹
`EventSource()` æ„é€ å‡½æ•°è¿”å›ä¸€ä¸ªæ–°å»ºçš„ `EventSource`ï¼Œå®ƒä»£è¡¨äº†ä¸€ä¸ªè¿œç¨‹èµ„æºã€‚
```js
const sse = new EventSource(url);
```
æ¯”å¦‚ï¼š
```js
const sse = new EventSource('http://localhost:3000/events');
```
`url` å¯ä»¥ä¸å½“å‰ç½‘å€åŒåŸŸï¼Œä¹Ÿå¯ä»¥è·¨åŸŸï¼›è·¨åŸŸçš„æ—¶å€™å°±è¦æŒ‡å®šç¬¬äºŒä¸ªå‚æ•° `withCredentials` å±æ€§ä¸º `true`ã€‚æ¯”å¦‚ï¼š
```js
const sse = new EventSource(url, {withCredentials: true});
```
EventSource å®ä¾‹çš„ `readyState` å±æ€§è¡¨ç¤ºå½“å‰è¿æ¥çš„çŠ¶æ€ã€‚è¯¥å±æ€§åªè¯»ï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š
- `0(EventSource.CONNECTING)`ï¼šè¡¨ç¤ºè¿æ¥è¿˜æœªå»ºç«‹ï¼Œæˆ–è€…æ–­çº¿æ­£åœ¨é‡è¿ã€‚
- `1(EventSource.OPEN)`ï¼šè¡¨ç¤ºè¿æ¥å·²ç»å»ºç«‹ï¼Œå¯ä»¥æ¥å—æ•°æ®ã€‚
- `2(EventSource.CLOSED)`ï¼šè¡¨ç¤ºè¿æ¥å·²æ–­ï¼Œä¸”ä¸ä¼šé‡è¿ã€‚

### ä½¿ç”¨ EventSource ç›‘å¬æœåŠ¡ç«¯äº‹ä»¶
è¿æ¥ä¸€æ—¦å»ºç«‹ï¼Œå°±ä¼šè§¦å‘ `open` äº‹ä»¶ï¼Œå¯ä»¥åœ¨ `onopen` å±æ€§å®šä¹‰å›è°ƒå‡½æ•°ã€‚
```js
sse.onopen = function (event) {
    console.log('ğŸš€ ~ sse.onopen:', event)
}
```
æˆ–è€…ä½¿ç”¨ `addEventListener` æ–¹æ³•ç›‘å¬ï¼š
```js
sse.addEventListener('open', function (event) {
    console.log('ğŸš€ ~ event:', event)
})
```
å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„æ•°æ®ï¼Œå°±ä¼šè§¦å‘ `message` äº‹ä»¶ï¼Œå¯ä»¥åœ¨ `onmessage` å±æ€§çš„å›è°ƒå‡½æ•°:
```js
sse.onmessage = function (event) {
    const newElement = document.createElement("p");
    const eventObject = JSON.parse(event.data);
    newElement.textContent = `Message: ${eventObject.message} at ${eventObject.timestamp}`
    messages.appendChild(newElement);
};
```

å¦‚æœå‘ç”Ÿé€šä¿¡é”™è¯¯ï¼ˆæ¯”å¦‚è¿æ¥ä¸­æ–­ï¼‰ï¼Œå°±ä¼šè§¦å‘ `error` äº‹ä»¶ï¼Œå¯ä»¥åœ¨ `onerror` å±æ€§å®šä¹‰å›è°ƒå‡½æ•°ã€‚
```js
sse.onerror = function (event) {
    console.log('ğŸš€ ~ sse.onerror:', event)
}
```
å¦‚æœè¦å˜æ¯” SSE è¿æ¥ï¼Œå¯ä»¥ä» `close` æ–¹æ³•ï¼š
```js
sse.close()
```
å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
```js
// æœåŠ¡ç«¯ä»£ç 
import express from 'express';

const app = express();
const PORT = 3000;

app.use(express.static('public'));

app.get('/events', function (req, res) {
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('X-Accel-Buffering', 'no');

    res.flushHeaders();

    let startTime = Date.now();

    const sendEvent = () => {
        const data = { message: 'Hello World', timestamp: new Date() };
        res.write(`: this is comment\nid: ${Date.now()}\ndate: ${new Date()}\ndata: ${JSON.stringify(data)}\n\n`);

        // æ¯éš”2ç§’å‘é€ä¸€æ¬¡æ¶ˆæ¯
        setTimeout(sendEvent, 2000);
    };

    sendEvent();
});

app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
```
å®¢æˆ·ç«¯æ¼”ç¤ºé¡µé¢çš„ä»£ç ï¼š
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSE Example</title>
</head>

<body>
    <h1>Server-Sent Events</h1>
    <div id="messages"></div>

    <script>
        const sse = new EventSource('http://localhost:3000/events');
        const messages = document.getElementById('messages');

        // sse.onopen = function (event) {
        //     console.log('ğŸš€ ~ sse.onopen:', event)
        // }
        sse.addEventListener('open', function (event) {
            console.log('ğŸš€ ~ event:', event)
        })
        sse.onmessage = function (event) {
            const newElement = document.createElement("p");
            const eventObject = JSON.parse(event.data);
            newElement.textContent = `Message: ${eventObject.message} at ${eventObject.timestamp}`
            messages.appendChild(newElement);
        };

        sse.onerror = function (event) {
            console.log('ğŸš€ ~ sse.onerror:', event)
        }

        // sse.close();
    </script>
</body>

</html>
```
### å¤„ç†æœåŠ¡ç«¯å‘é€çš„å¤šç§äº‹ä»¶ç±»å‹
ä¸‹é¢å°±æ¥æ¨¡æ‹Ÿå¤šç§äº‹ä»¶ç±»å‹ï¼ŒæœåŠ¡ç«¯æŒ‰ç…§æ—¶é—´æ¨é€ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼š`custom1` å’Œ `custom2`ï¼Œé»˜è®¤æ¨é€çš„äº‹ä»¶ç±»å‹ä¸º `message`ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š
#### æœåŠ¡ç«¯çš„ä»£ç 
![](./assets/a81fa038-e144-4fe9-b9d9-7a2cf78bc33f.png)

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```js
import express from 'express';

const app = express();
const PORT = 3000;

app.use(express.static('public'));

const eventData = {
    custom1: { message: 'this is custom1' },
    custom2: { message: 'this is custom2' },
    default: { message: 'Hello World' }
};

app.get('/events', function (req, res) {
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('X-Accel-Buffering', 'no');

    res.flushHeaders();

    let startTime = Date.now();

    const sendEvent = () => {
        const time = Date.now() - startTime

        if (time >= 10000) {
            res.write(`event: custom1\ndata: ${JSON.stringify({ ...eventData.custom1, timestamp: new Date() })}\n\n`);
        } else if (time >= 5000) {
            res.write(`event: custom2\ndata: ${JSON.stringify({ ...eventData.custom2, timestamp: new Date() })}\n\n`);
        } else {
            const data = { ...eventData.default, timestamp: new Date() };
            res.write(`: this is comment\nid: ${Date.now()}\ndate: ${new Date()}\ndata: ${JSON.stringify(data)}\n\n`);
        }

        // æ¯éš”2ç§’å‘é€ä¸€æ¬¡æ¶ˆæ¯
        setTimeout(sendEvent, 2000);
    };

    sendEvent();
});

app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
```

#### å®¢æˆ·ç«¯çš„ä»£ç ï¼ˆä»¥æµè§ˆå™¨ä¸ºä¾‹ï¼‰

![](./assets/41896f78-d8ce-4010-8aeb-8be2435b9030.png)

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SSE Example</title>
</head>

<body>
    <h1>Server-Sent Events</h1>
    <div id="messages"></div>

    <script>
        const sse = new EventSource('http://localhost:3000/events');
        const messages = document.getElementById('messages');

        // sse.onopen = function (event) {
        //     console.log('ğŸš€ ~ sse.onopen:', event)
        // }
        sse.addEventListener('open', function (event) {
            console.log('ğŸš€ ~ event:', event)
        })

        sse.onerror = function (event) {
            console.log('ğŸš€ ~ sse.onerror:', event)
        }

        // sse.close();

        // ç›‘å¬ message äº‹ä»¶
        sse.onmessage = function (event) {
            writeMessage('message', event.data);
        };

        // ç›‘å¬ custom2 äº‹ä»¶
        sse.addEventListener('custom2', function (event) {
            writeMessage('custom2', event.data)
        })

        // ç›‘å¬ custom1 äº‹ä»¶
        sse.addEventListener('custom1', function (event) {
            writeMessage('custom1', event.data)
        })

        function writeMessage (tag, data) {
            data = JSON.parse(data)
            const newElement = document.createElement("p");
            newElement.textContent = `event type: ${tag}, Message: ${data.message} at ${data.timestamp}`
            messages.appendChild(newElement);
        }
    </script>
</body>
</html>
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### æµè§ˆå™¨é™åˆ¶ HTTP1.1 è¿æ¥ä¸Šé™é—®é¢˜
åœ¨ä¸»æµçš„edgeã€chromeã€ç«ç‹æµè§ˆå™¨ä¸­ï¼Œéƒ½é™åˆ¶HTTP1.1çš„è¿æ¥æ•°ä¸Šçº¿ä¸º6ã€‚æ­¤é™åˆ¶åœ¨ HTTP è§„èŒƒï¼ˆRFC2616ï¼‰ä¸­å®šä¹‰ã€‚å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨æ¯ä¸ªåŸŸå…è®¸å…­ä¸ªè¿æ¥ã€‚æ¨èé˜…è¯» [What are Max Parallel HTTP Connections in a Browser?](https://www.geeksforgeeks.org/what-are-max-parallel-http-connections-in-a-browser/)ï¼

æ„æ€å°±æ˜¯ä¸€ä¸ªæµè§ˆå™¨è®¿é—®ç›¸åŒçš„åŸŸï¼ˆip+ç«¯å£ ä¸ºä¸€ä¸ªåŸŸï¼‰åªèƒ½å¼€6ä¸ªï¼Œæ•°æ®æµè§ˆå™¨åŒåŸŸå¹¶å‘è¯·æ±‚é™åˆ¶ï¼Œåˆ°ç¬¬7ä¸ªæ—¶å¼€å§‹æ’é˜Ÿï¼Œåœ¨è¿™äº›æµè§ˆå™¨ä¸­ï¼Œæ¥æ”¶çš„ SSE æ•°æœ€å¤š6ä¸ªã€‚
> æ³¨æ„ï¼Œè¿™é‡Œæ˜¯è¯´çš„æ˜¯æµè§ˆå™¨ä¸æ˜¯æ ‡ç­¾é¡µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæµè§ˆå™¨å¦‚æœå¼€å¤šä¸ªæ ‡ç­¾é¡µï¼Œè¿™äº›æ ‡ç­¾é¡µçš„è¿æ¥æ€»æ•°ä¸èƒ½è¶…è¿‡6ä¸ªï¼Œç¬¬ä¸ƒä¸ªå°±æ— æ³•è¿æ¥äº†ã€‚

åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œå¦‚æœæœ‰å¤šç§ç±»å‹çš„æ•°æ®ï¼Œå…­ä¸ªè¿æ¥æ•°æ˜¯è¿œä¸å¤Ÿç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œæå‡ºä¸¤ä¸ªè§£å†³åŠæ³•ã€‚
1. å‡çº§ HTTP åè®®ä¸º HTTP/2ï¼šHTTP/2 åè®®å…è®¸åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå¤šè·¯å¤ç”¨ï¼Œä»è€Œé¿å…äº† HTTP 1.1 çš„è¿æ¥æ•°é™åˆ¶ã€‚
2. æœåŠ¡ç«¯å¼€å¯å¤šä¸ªç«¯å£ï¼šå¦‚æœä¸€ä¸ªç«¯å£å¯ä»¥æœ‰6ä¸ª SSE è¿æ¥ï¼Œé‚£ä¹ˆé…ç½®10ä¸ªç«¯å£å°±å¯ä»¥æ”¯æŒ60ä¸ªæµè§ˆå™¨è¿æ¥ã€‚å‰ç«¯éœ€è¦è®°å½•å½“å‰ä½¿ç”¨çš„ç«¯å£ï¼Œå¹¶åœ¨è¯·æ±‚è·¯å¾„åé™„åŠ ä¸åŒçš„ç«¯å£å·ï¼Œå½“ä¸€ä¸ªç«¯å£çš„è¿æ¥æ•°è¾¾åˆ°6ä¸ªæ—¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç«¯å£
3. ä½¿ç”¨ ï¼šå¦‚æœéœ€è¦æ›´å¤æ‚çš„å®æ—¶é€šä¿¡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ WSã€‚
4. ä¼˜åŒ–ç°æœ‰ SSE ä½¿ç”¨ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¸éœ€è¦åŒæ—¶æ‰“å¼€å¤šä¸ª SSE è¿æ¥ã€‚é€šè¿‡ä¼˜åŒ–åº”ç”¨é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„ SSE è¿æ¥ï¼Œæˆ–è€…åœ¨ä¸åŒçš„é¡µé¢æˆ–æ ‡ç­¾é¡µä¸­ä½¿ç”¨ä¸åŒçš„ SSE è¿æ¥ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜æŠ€æœ¯æ ˆçš„æƒ…å†µä¸‹è§£å†³è¿æ¥é™åˆ¶é—®é¢˜ã€‚

### SSE çš„è·¨åŸŸé—®é¢˜
è·¨åŸŸæ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œæ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š
- åå‘ä»£ç†
- åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®å“åº”å¤´ `Access-Control-Allow-Origin` æ¥å…è®¸ç‰¹å®šçš„å¤–éƒ¨åŸŸè®¿é—®èµ„æºã€‚å¦‚æœéœ€è¦æ”¯æŒå‡­è¯ï¼ˆå¦‚ Cookiesï¼‰ï¼Œåˆ™è¿˜éœ€è¦è®¾ç½® `Access-Control-Allow-Credentials` ä¸º `true`ã€‚
  ```js
  Access-Control-Allow-Origin: *
  Access-Control-Allow-Credentials: true
  ```
- ...

### å¦‚ä½•å¤„ç†æµè§ˆå™¨ä¸æ”¯æŒ SSE çš„æƒ…å†µ
#### ä½¿ç”¨ Polyfill
åœ¨æµè§ˆå™¨ä¸­æ£€æµ‹æ˜¯å¦æ”¯æŒï¼š
```js
if('EventSource' in window){
    // support SSE
}
```
åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œå¦‚æœä¸æ”¯æŒè¿˜æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹çš„ polyfillï¼š
- [event-source-polyfill](https://github.com/Yaffle/EventSource?spm=5176.28103460.0.0.297c3da2CABnfG)
- [React Native EventSource](https://github.com/binaryminds/react-native-sse)ï¼šé€‚é…çš„ react-native ç¯å¢ƒçš„ SSEã€‚
- [flutter_client_sse](https://pub.dev/packages/flutter_client_sse)ï¼šé€‚é… Flutter ç¯å¢ƒ çš„ SSEã€‚

#### æä¾›æ›¿ä»£æŠ€æœ¯
å¯ä»¥ä½¿ç”¨é•¿è½®è¯¢æˆ– WebSocket ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆã€‚é•¿è½®è¯¢æ˜¯ä¸€ç§ä¼ ç»Ÿçš„æŠ€æœ¯ï¼Œé€šè¿‡å®šæœŸå‘é€è¯·æ±‚æ¥æ¨¡æ‹Ÿå®æ—¶é€šä¿¡ã€‚WebSocket åˆ™æä¾›äº†å…¨åŒå·¥é€šä¿¡èƒ½åŠ›ï¼Œå¯ä»¥å®ç°æ›´å¤æ‚çš„å®æ—¶äº¤äº’åœºæ™¯ã€‚

#### å¼•å¯¼ç”¨æˆ·å‡çº§æµè§ˆå™¨
å¦‚æœå¯èƒ½ï¼Œå¯ä»¥é€šè¿‡ç”¨æˆ·ç•Œé¢æç¤ºç”¨æˆ·å…¶æµè§ˆå™¨ä¸æ”¯æŒ SSEï¼Œå¹¶å»ºè®®ä»–ä»¬å‡çº§åˆ°æ”¯æŒ SSE çš„æµè§ˆå™¨ç‰ˆæœ¬æˆ–è€…æ¢ç”¨æµè§ˆå™¨ã€‚

## æ€»ç»“
Server-Sent Events (SSE) æŠ€æœ¯ï¼Œä½œä¸ºå®ç°æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ•°æ®çš„è§£å†³æ–¹æ¡ˆã€‚SSE æ˜¯ HTML5 æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡åŸºäº HTTP åè®®çš„å•å‘æ•°æ®æµä¼ è¾“ï¼Œä½¿æœåŠ¡å™¨èƒ½å¤Ÿå®æ—¶å‘å®¢æˆ·ç«¯å‘é€æ›´æ–°ã€‚

ç›¸æ¯” WebSocket å’Œ HTTP è½®è¯¢ï¼ŒSSE æ›´ä¸ºç®€å•è½»é‡ï¼Œå°¤å…¶é€‚ç”¨äºå•å‘æ•°æ®æ¨é€åœºæ™¯ï¼Œå¦‚æ–°é—»æ›´æ–°ã€å®æ—¶é€šçŸ¥ã€ç‰©è”ç½‘è®¾å¤‡æ•°æ®ç­‰ã€‚æ–‡ç« è¯¦ç»†ä»‹ç»äº† SSE çš„åŸºæœ¬åŸç†ã€æ•°æ®æ ¼å¼ã€ä»¥åŠå¦‚ä½•åœ¨å‰ç«¯é€šè¿‡ EventSource API å®ç° SSEï¼ŒåŒ…å«äº†å…·ä½“çš„ä»£ç ç¤ºä¾‹ä¸æ­¥éª¤ã€‚

å°½ç®¡ SSE æœ‰è¯¸å¤šä¼˜åŠ¿ï¼Œå¦‚ä¸ç°æœ‰ HTTP å…¼å®¹ã€æ”¯æŒæ–­çº¿é‡è¿å’Œè‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹ç­‰ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ä¸æ”¯æŒåŒå‘é€šä¿¡å’ŒäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“ã€‚æœ€åè¿˜æ¢è®¨äº†åœ¨å®é™…å¼€å‘ä¸­å¯èƒ½é‡åˆ°çš„æµè§ˆå™¨è¿æ¥æ•°é™åˆ¶å’Œè·¨åŸŸé—®é¢˜ï¼Œå¹¶æä¾›äº†ç›¸åº”çš„è§£å†³æ–¹æ¡ˆã€‚
